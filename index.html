<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<title>Mini Fortnite Lite</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<style>
  html, body {
    margin: 0; padding: 0;
    background: #05070b;
    overflow: hidden;
    touch-action: none;
    font-family: system-ui, sans-serif;
    color: #fff;
  }
  #gameCanvas { display: block; background: #10151c; }
  #ui { position: fixed; inset: 0; pointer-events: none; }
  #topBar {
    position: absolute; left: 10px; top: 10px;
    font-size: 13px; background: #0008;
    padding: 6px 10px; border-radius: 8px;
  }
  #stormBar { margin-top: 4px; width: 140px; height: 6px; background: #333; border-radius: 4px; overflow: hidden; }
  #stormBarFill { width: 100%; height: 100%; background: linear-gradient(90deg, #4cf, #f4f); }
  
  #toolbar {
    position: absolute; left: 50%; bottom: 10px;
    transform: translateX(-50%); display: flex; gap: 6px; pointer-events: auto;
  }
  .slot {
    width: 50px; height: 50px; border-radius: 8px;
    border: 2px solid #555; background: #0009;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: #eee; position: relative;
  }
  .slot.active { border-color: #ffd54f; box-shadow: 0 0 8px #ffd54f; }
  
  .arrowBtn {
    position: absolute; bottom: 20px; width: 50px; height: 50px;
    border-radius: 50%; background: #fff2; border: 2px solid #fff5;
    color: #fff; font-size: 24px; display: flex; align-items: center;
    justify-content: center; pointer-events: auto; z-index: 10;
  }
  #leftArrow { left: 20px; }
  #rightArrow { right: 20px; }
  #resetBtn {
    position: absolute; left: 15px; bottom: 80px; width: 40px; height: 40px;
    border-radius: 50%; background: #f448; border: 1px solid #f44;
    color: #fff; display: flex; align-items: center; justify-content: center;
    pointer-events: auto; z-index: 10;
  }

  #joystickArea { position: absolute; left: 0; bottom: 0; width: 50vw; height: 50vh; pointer-events: auto; }
  #joystickBase { position: absolute; width: 100px; height: 100px; background: #fff2; border: 2px solid #fff3; border-radius: 50%; display: none; transform: translate(-50%, -50%); }
  #joystickStick { position: absolute; width: 50px; height: 50px; background: #fff5; border-radius: 50%; display: none; transform: translate(-50%, -50%); }

  #shootBtn { position: absolute; right: 30px; bottom: 100px; width: 80px; height: 80px; background: #f44a; border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
  
  #gameOver {
    position: absolute; inset: 0; display: none;
    align-items: center; justify-content: center; flex-direction: column;
    background: #000d; z-index: 100; pointer-events: auto;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="ui">
  <div id="topBar">
    HP: <span id="hpText">100</span> | Bots: <span id="botsText">0</span> | Storm: <span id="stormText">Venter</span><br>
    Kills: <span id="killText">0</span> | Hi: <span id="hiScoreText">0</span>
    <div id="stormBar"><div id="stormBarFill"></div></div>
  </div>
  <div id="toolbar"></div>
  <div id="leftArrow" class="arrowBtn">◀</div>
  <div id="rightArrow" class="arrowBtn">▶</div>
  <div id="resetBtn">X</div>
  <div id="joystickArea">
    <div id="joystickBase"></div>
    <div id="joystickStick"></div>
  </div>
  <div id="shootBtn">SKYT</div>
  <div id="gameOver">
    <h1 id="gameOverTitle">GAME OVER</h1>
    <button id="restartBtn">Prøv igjen</button>
  </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const W = () => canvas.width = window.innerWidth;
const H = () => canvas.height = window.innerHeight;
W(); H();

// Spill-innstillinger
const world = { width: 2500, height: 2500 };
const MAX_BOTS_TOTAL = 30;
let gameRunning = true;
let lastTime = 0;
let kills = 0;
let hiScore = localStorage.getItem("mw_hiscore") || 0;
document.getElementById('hiScoreText').textContent = hiScore;

const weaponTypes = {
  pistol: { name: "Pistol", color: "#aaa", dmg: 15, fireRate: 400, r: 4 },
  smg: { name: "SMG", color: "#4f4", dmg: 10, fireRate: 150, r: 3 },
  sniper: { name: "Sniper", color: "#f4f", dmg: 80, fireRate: 1200, r: 6 }
};

let player, bots, bullets, weapons, blocks, inventory, activeSlot;
let stormActive = false, stormRadius = 2000, stormElapsed = 0, stormShrinkTime = 60000;
const stormCenter = { x: world.width/2, y: world.height/2 };

function resetGame() {
  player = { x: world.width/2, y: world.height/2, z: 0, vz: 0, r: 15, hp: 100, speed: 4, vx: 0, vy: 0, aimAngle: 0, onGround: true, gravity: 0.5, jumpStrength: 8 };
  bots = []; bullets = []; weapons = []; blocks = [];
  inventory = ["pistol"]; activeSlot = 0;
  kills = 0;
  stormActive = false;
  stormRadius = 2000;
  stormElapsed = 0;
  totalBotsSpawned = 0;
  gameRunning = true;
  document.getElementById('gameOver').style.display = 'none';
  
  // Lag noen vegger/blokker
  for(let i=0; i<15; i++) {
    blocks.push({ x: Math.random()*world.width, y: Math.random()*world.height, w: 100, h: 100 });
  }
  updateToolbar();
}

// Input håndtering
const keys = {};
let joystickVector = { x: 0, y: 0 };
let shootPressed = false;

window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

// Joystick logikk
const jArea = document.getElementById('joystickArea');
const jBase = document.getElementById('joystickBase');
const jStick = document.getElementById('joystickStick');
jArea.ontouchstart = e => {
  const t = e.touches[0];
  jBase.style.display = jStick.style.display = 'block';
  jBase.style.left = t.clientX + 'px'; jBase.style.top = t.clientY + 'px';
  jStick.style.left = t.clientX + 'px'; jStick.style.top = t.clientY + 'px';
};
jArea.ontouchmove = e => {
  const t = e.touches[0];
  const dx = t.clientX - parseFloat(jBase.style.left);
  const dy = t.clientY - parseFloat(jBase.style.top);
  const dist = Math.hypot(dx, dy);
  const max = 50;
  const angle = Math.atan2(dy, dx);
  const moveDist = Math.min(dist, max);
  jStick.style.left = parseFloat(jBase.style.left) + Math.cos(angle) * moveDist + 'px';
  jStick.style.top = parseFloat(jBase.style.top) + Math.sin(angle) * moveDist + 'px';
  joystickVector = { x: (Math.cos(angle) * moveDist)/max, y: (Math.sin(angle) * moveDist)/max };
};
jArea.ontouchend = () => {
  jBase.style.display = jStick.style.display = 'none';
  joystickVector = { x: 0, y: 0 };
};

// Skyt-knapp
const sBtn = document.getElementById('shootBtn');
sBtn.onpointerdown = () => shootPressed = true;
sBtn.onpointerup = () => shootPressed = false;

// Våpenbytte
document.getElementById('leftArrow').onclick = () => { activeSlot = (activeSlot - 1 + inventory.length) % inventory.length; updateToolbar(); };
document.getElementById('rightArrow').onclick = () => { activeSlot = (activeSlot + 1) % inventory.length; updateToolbar(); };
document.getElementById('resetBtn').onclick = () => player.hp = 0;
document.getElementById('restartBtn').onclick = resetGame;

function updateToolbar() {
  const container = document.getElementById('toolbar');
  container.innerHTML = '';
  inventory.forEach((w, i) => {
    const div = document.createElement('div');
    div.className = `slot ${i === activeSlot ? 'active' : ''}`;
    div.innerHTML = `<span>${weaponTypes[w].name}</span>`;
    container.appendChild(div);
  });
}

function spawnBot() {
  bots.push({
    x: Math.random() * world.width, y: Math.random() * world.height,
    r: 15, hp: 50, speed: 2, vx: 0, vy: 0, wanderTimer: 0
  });
}

function spawnWeapon() {
  const types = Object.keys(weaponTypes);
  const type = types[Math.floor(Math.random() * types.length)];
  weapons.push({ x: Math.random()*world.width, y: Math.random()*world.height, r: 10, type: weaponTypes[type], typeKey: type });
}

function shootBullet() {
  const w = weaponTypes[inventory[activeSlot]];
  bullets.push({
    x: player.x, y: player.y,
    vx: Math.cos(player.aimAngle) * 10, vy: Math.sin(player.aimAngle) * 10,
    r: w.r, dmg: w.dmg, life: 2000, color: w.color
  });
}

function gameOver(win) {
  gameRunning = false;
  document.getElementById('gameOver').style.display = 'flex';
  document.getElementById('gameOverTitle').textContent = win ? "VICTORY ROYALE!" : "GAME OVER";
}

let spawnTimer = 0, weaponSpawnTimer = 0, shootCooldown = 0, totalBotsSpawned = 0;

// Update og Draw funksjonene dine (integrert og fikset)
function update(dt) {
  if (!gameRunning) return;

  // Bevegelse
  let moveX = joystickVector.x;
  let moveY = joystickVector.y;
  if (keys['w']) moveY -= 1; if (keys['s']) moveY += 1;
  if (keys['a']) moveX -= 1; if (keys['d']) moveX += 1;

  if (moveX !== 0 || moveY !== 0) {
    const len = Math.hypot(moveX, moveY);
    player.vx = (moveX / len) * player.speed;
    player.vy = (moveY / len) * player.speed;
    player.aimAngle = Math.atan2(moveY, moveX);
  } else {
    player.vx *= 0.8; player.vy *= 0.8;
  }

  // Kollisjon blokker
  let nX = player.x + player.vx;
  let nY = player.y + player.vy;
  blocks.forEach(b => {
    if (nX + player.r > b.x && nX - player.r < b.x + b.w && player.y + player.r > b.y && player.y - player.r < b.y + b.h) nX = player.x;
    if (player.x + player.r > b.x && player.x - player.r < b.x + b.w && nY + player.r > b.y && nY - player.r < b.y + b.h) nY = player.y;
  });
  player.x = Math.max(player.r, Math.min(world.width - player.r, nX));
  player.y = Math.max(player.r, Math.min(world.height - player.r, nY));

  // Storm logikk
  if (kills > 2) stormActive = true;
  if (stormActive) {
    stormElapsed += dt;
    let t = Math.min(1, stormElapsed / stormShrinkTime);
    stormRadius = 2000 * (1 - t) + 200;
    document.getElementById('stormBarFill').style.width = (100 - t*100) + "%";
    const dist = Math.hypot(player.x - stormCenter.x, player.y - stormCenter.y);
    if (dist > stormRadius) player.hp -= 0.1;
  }

  // Spawns
  spawnTimer += dt;
  if (spawnTimer > 3000 && bots.length < 10) { spawnBot(); spawnTimer = 0; }
  weaponSpawnTimer += dt;
  if (weaponSpawnTimer > 5000) { spawnWeapon(); weaponSpawnTimer = 0; }

  // Bots AI
  bots.forEach(bot => {
    const dx = player.x - bot.x; const dy = player.y - bot.y;
    const dist = Math.hypot(dx, dy);
    bot.x += (dx/dist) * bot.speed; bot.y += (dy/dist) * bot.speed;
    if (dist < player.r + bot.r) player.hp -= 0.5;
  });

  // Bullets
  bullets.forEach((b, i) => {
    b.x += b.vx; b.y += b.vy; b.life -= dt;
    bots.forEach((bot, bi) => {
      if (Math.hypot(b.x - bot.x, b.y - bot.y) < bot.r + b.r) {
        bot.hp -= b.dmg; b.life = 0;
        if (bot.hp <= 0) {
          bots.splice(bi, 1); kills++;
          document.getElementById('killText').textContent = kills;
          if(kills > hiScore) { hiScore = kills; localStorage.setItem("mw_hiscore", hiScore); document.getElementById('hiScoreText').textContent = hiScore; }
        }
      }
    });
  });
  bullets = bullets.filter(b => b.life > 0);

  // Våpen opplukking
  weapons.forEach((w, i) => {
    if (Math.hypot(player.x - w.x, player.y - w.y) < player.r + w.r) {
      if (!inventory.includes(w.typeKey)) { inventory.push(w.typeKey); updateToolbar(); }
      weapons.splice(i, 1);
    }
  });

  // Skyting
  shootCooldown -= dt;
  if (shootPressed && shootCooldown <= 0) {
    shootBullet();
    shootCooldown = weaponTypes[inventory[activeSlot]].fireRate;
  }

  document.getElementById('hpText').textContent = Math.ceil(player.hp);
  if (player.hp <= 0) gameOver(false);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const camX = player.x - canvas.width/2;
  const camY = player.y - canvas.height/2;

  ctx.save();
  ctx.translate(-camX, -camY);

  // Verdensgrense
  ctx.strokeStyle = "#444";
  ctx.strokeRect(0, 0, world.width, world.height);

  // Storm sirkel
  ctx.beginPath();
  ctx.arc(stormCenter.x, stormCenter.y, stormRadius, 0, Math.PI*2);
  ctx.strokeStyle = "rgba(100, 200, 255, 0.5)";
  ctx.lineWidth = 5;
  ctx.stroke();

  blocks.forEach(b => { ctx.fillStyle = "#334"; ctx.fillRect(b.x, b.y, b.w, b.h); });
  weapons.forEach(w => { ctx.fillStyle = w.type.color; ctx.beginPath(); ctx.arc(w.x, w.y, w.r, 0, Math.PI*2); ctx.fill(); });
  bots.forEach(bot => { ctx.fillStyle = "#f44"; ctx.beginPath(); ctx.arc(bot.x, bot.y, bot.r, 0, Math.PI*2); ctx.fill(); });
  bullets.forEach(b => { ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); });

  // Spiller
  ctx.save();
  ctx.translate(player.x, player.y);
  ctx.rotate(player.aimAngle);
  ctx.fillStyle = "#4cf";
  ctx.beginPath(); ctx.arc(0, 0, player.r, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "#fff"; ctx.fillRect(10, -3, 15, 6); // Våpenløp
  ctx.restore();

  ctx.restore();
}

function loop(timestamp) {
  const dt = timestamp - lastTime;
  lastTime = timestamp;
  update(dt || 16);
  draw();
  requestAnimationFrame(loop);
}

resetGame();
requestAnimationFrame(loop);
</script>
</body>
</html>
