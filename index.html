<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<title>Mini Fortnite Lite - Bot Storm Damage</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #05070b;
    overflow: hidden;
    touch-action: none;
    font-family: system-ui, sans-serif;
    color: #fff;
  }

  #gameCanvas {
    display: block;
    margin: 0 auto;
    background: radial-gradient(circle at center, #1f2b3a 0, #05070b 70%);
  }

  #ui {
    position: fixed;
    inset: 0;
    pointer-events: none;
  }

  #topBar {
    position: absolute;
    left: 10px;
    top: 10px;
    font-size: 13px;
    background: #0008;
    padding: 6px 10px;
    border-radius: 8px;
  }

  #stormBar {
    margin-top: 4px;
    width: 140px;
    height: 6px;
    background: #333;
    border-radius: 4px;
    overflow: hidden;
  }
  #stormBarFill {
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, #4cf, #f4f);
  }

  #toolbar {
    position: absolute;
    left: 50%;
    bottom: 10px;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    pointer-events: auto;
  }
  .slot {
    width: 52px;
    height: 52px;
    border-radius: 8px;
    border: 2px solid #999;
    background: #0009;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    position: relative;
    color: #eee;
  }
  .slot.active {
    border-color: #ffd54f;
    box-shadow: 0 0 8px #ffd54f;
  }
  .slot span {
    text-align: center;
  }
  .slotIndex {
    position: absolute;
    left: 4px;
    bottom: 2px;
    font-size: 9px;
    opacity: 0.7;
  }

  .arrowBtn {
    position: absolute;
    bottom: 25px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #0008;
    border: 2px solid #888;
    color: #fff;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    user-select: none;
    z-index: 99999;
  }

  #leftArrow { left: calc(50% - 220px); }
  #rightArrow { right: calc(50% - 220px); }

  #resetBtn {
    position: absolute;
    left: 15px;
    bottom: 15px;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: #c33c;
    border: 2px solid #f55;
    color: #fff;
    font-size: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    user-select: none;
    z-index: 99999;
  }

  #joystickArea {
    position: absolute;
    left: 0;
    bottom: 0;
    width: 45vw;
    height: 45vh;
    pointer-events: auto;
  }
  #joystickBase, #joystickStick {
    position: absolute;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.4;
  }
  #joystickBase {
    width: 120px;
    height: 120px;
    background: #fff3;
    border: 2px solid #fff5;
    display: none;
  }
  #joystickStick {
    width: 60px;
    height: 60px;
    background: #fff6;
    display: none;
  }

  #shootBtn, #jumpBtn {
    position: absolute;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    pointer-events: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    user-select: none;
    font-size: 13px;
  }
  #shootBtn { right: 5vw; bottom: 12vh; background: #f44a; border: 2px solid #f88; }
  #jumpBtn { right: 20vw; bottom: 22vh; background: #4af8; border: 2px solid #8ff; }

  #gameOver {
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: #000b;
    font-size: 24px;
    pointer-events: auto;
    z-index: 9999;
  }

  button {
    padding: 8px 16px;
    margin-top: 10px;
    border-radius: 6px;
    border: none;
    background: #3a8;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>

<div id="ui">
  <div id="topBar">
    HP: <span id="hpText">100</span> |
    Bots: <span id="botsText">0</span> |
    Storm: <span id="stormText">Rolig</span> |
    Kills: <span id="killText">0</span> |
    Hi‑Score: <span id="hiScoreText">0</span><br/>
    Våpen: <span id="weaponText">Ingen</span>
    <div id="stormBar">
      <div id="stormBarFill"></div>
    </div>
  </div>

  <div id="toolbar"></div>
  <div id="leftArrow" class="arrowBtn">◀</div>
  <div id="rightArrow" class="arrowBtn">▶</div>

  <div id="joystickArea">
    <div id="joystickBase"></div>
    <div id="joystickStick"></div>
  </div>

  <div id="shootBtn">SKYT</div>
  <div id="jumpBtn">HOPP</div>

  <div id="gameOver">
    <div id="gameOverText"></div>
    <button id="restartBtn">Spill igjen</button>
  </div>

  <div id="resetBtn">X</div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  const size = Math.min(window.innerWidth, window.innerHeight);
  canvas.width = size;
  canvas.height = size;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const hpText = document.getElementById('hpText');
const botsText = document.getElementById('botsText');
const stormText = document.getElementById('stormText');
const stormBarFill = document.getElementById('stormBarFill');
const weaponText = document.getElementById('weaponText');
const gameOverEl = document.getElementById('gameOver');
const gameOverText = document.getElementById('gameOverText');
const restartBtn = document.getElementById('restartBtn');
const killText = document.getElementById('killText');
const hiScoreText = document.getElementById('hiScoreText');
const toolbarEl = document.getElementById('toolbar');
const joystickBase = document.getElementById('joystickBase');
const joystickStick = document.getElementById('joystickStick');
const shootBtn = document.getElementById('shootBtn');
const jumpBtn = document.getElementById('jumpBtn');
const leftArrow = document.getElementById('leftArrow');
const rightArrow = document.getElementById('rightArrow');
const resetBtn = document.getElementById('resetBtn');

const W = () => canvas.width;
const H = () => canvas.height;

const world = { width: 3000, height: 3000 };
const player = {
  x: world.width / 2, y: world.height / 2, r: 16,
  speed: 2.4, vx: 0, vy: 0, hp: 100,
  aimAngle: 0, z: 0, vz: 0, onGround: true,
  jumpStrength: 7, gravity: 0.4,
  weaponSlots: [null, null, null, null, null],
  activeSlot: 0
};

let bullets = [], bots = [], blocks = [], weapons = [];
let lastTime = 0, spawnTimer = 0, weaponSpawnTimer = 0, gameRunning = true;
let stormRadius, stormCenter, stormShrinkTime = 60000, stormElapsed = 0, stormActive = true;
let kills = 0, hiScore = 0, totalBotsSpawned = 0;
const MAX_BOTS_TOTAL = 50;

const weaponTypes = [
  { name: "Rifle", dmg: 20, color: "#4cf", fireRate: 220, bulletSpeed: 7 },
  { name: "Shotgun", dmg: 45, color: "#fa4", fireRate: 600, bulletSpeed: 6, spread: 0.3, pellets: 5 },
  { name: "SMG", dmg: 12, color: "#9f4", fireRate: 120, bulletSpeed: 6.5 },
  { name: "Sniper", dmg: 70, color: "#f4f", fireRate: 900, bulletSpeed: 10 },
  { name: "Pistol", dmg: 18, color: "#ddd", fireRate: 300, bulletSpeed: 6.5 }
];

let shootPressed = false, jumpPressed = false, shootCooldown = 0;
let joystickActive = false, joystickCenter = { x: 0, y: 0 }, joystickVector = { x: 0, y: 0 };

function initToolbar() {
  toolbarEl.innerHTML = "";
  for (let i = 0; i < 5; i++) {
    const slot = document.createElement("div");
    slot.className = "slot" + (i === player.activeSlot ? " active" : "");
    slot.innerHTML = `<span>Tom</span><div class="slotIndex">${i+1}</div>`;
    slot.addEventListener("click", () => { player.activeSlot = i; updateToolbar(); updateWeaponText(); });
    toolbarEl.appendChild(slot);
  }
}

function updateToolbar() {
  const slots = toolbarEl.querySelectorAll(".slot");
  slots.forEach((el, i) => {
    el.classList.toggle("active", i === player.activeSlot);
    const w = player.weaponSlots[i];
    el.querySelector("span").textContent = w ? w.name : "Tom";
  });
}

function resetGame() {
  hiScore = parseInt(localStorage.getItem("mw_hiscore") || "0");
  kills = 0; killText.textContent = kills; hiScoreText.textContent = hiScore;
  totalBotsSpawned = 0;
  player.x = world.width / 2; player.y = world.height / 2;
  player.hp = 100; player.weaponSlots = [null, null, null, null, null];
  player.activeSlot = 0; bullets = []; bots = []; blocks = []; weapons = [];
  stormRadius = Math.min(world.width, world.height) * 0.45;
  stormCenter = { x: world.width / 2, y: world.height / 2 };
  stormElapsed = 0; gameRunning = true;
  gameOverEl.style.display = 'none';
  initBlocks(); initBots(); initToolbar(); updateToolbar(); updateWeaponText();
}

function initBlocks() {
  for (let i = 0; i < 60; i++) {
    blocks.push({
      x: 200 + Math.random() * (world.width - 400),
      y: 200 + Math.random() * (world.height - 400),
      w: 80 + Math.random() * 120, h: 80 + Math.random() * 120
    });
  }
}

function collidesCircleRect(cx, cy, cr, rect) {
  const closestX = Math.max(rect.x, Math.min(cx, rect.x + rect.w));
  const closestY = Math.max(rect.y, Math.min(cy, rect.y + rect.h));
  return Math.hypot(cx - closestX, cy - closestY) < cr;
}

function spawnBot() {
  if (totalBotsSpawned >= MAX_BOTS_TOTAL) return;
  const x = 120 + Math.random() * (world.width - 240);
  const y = 120 + Math.random() * (world.height - 240);
  bots.push({ x, y, r: 14, speed: 1.6 + Math.random() * 0.5, hp: 60, wanderTimer: 0, vx: 0, vy: 0 });
  totalBotsSpawned++;
}

function spawnWeapon() {
  const type = weaponTypes[Math.floor(Math.random() * weaponTypes.length)];
  weapons.push({ x: 150 + Math.random() * (world.width - 300), y: 150 + Math.random() * (world.height - 300), r: 12, type });
}

function updateWeaponText() {
  const w = player.weaponSlots[player.activeSlot];
  weaponText.textContent = w ? w.name : "Ingen";
}

// Kontroller
shootBtn.addEventListener('mousedown', () => shootPressed = true);
window.addEventListener('mouseup', () => shootPressed = false);
jumpBtn.addEventListener('mousedown', () => jumpPressed = true);
window.addEventListener('mouseup', () => jumpPressed = false);
leftArrow.addEventListener("click", () => { player.activeSlot = (player.activeSlot + 4) % 5; updateToolbar(); updateWeaponText(); });
rightArrow.addEventListener("click", () => { player.activeSlot = (player.activeSlot + 1) % 5; updateToolbar(); updateWeaponText(); });
resetBtn.addEventListener("click", () => player.hp = 0);

function update(dt) {
  if (!gameRunning) return;

  // Spillerbevegelse
  let moveX = joystickVector.x, moveY = joystickVector.y;
  const moveSpeed = player.speed * (dt / 16.67);
  player.vx = moveX * moveSpeed; player.vy = moveY * moveSpeed;

  if ((jumpPressed) && player.onGround) { player.vz = player.jumpStrength; player.onGround = false; }
  player.vz -= player.gravity * (dt / 16.67);
  player.z += player.vz * (dt / 16.67);
  if (player.z <= 0) { player.z = 0; player.vz = 0; player.onGround = true; }

  let newX = player.x + player.vx, newY = player.y + player.vy;
  for (const b of blocks) {
    if (collidesCircleRect(newX, player.y, player.r, b)) newX = player.x;
    if (collidesCircleRect(player.x, newY, player.r, b)) newY = player.y;
  }
  player.x = Math.max(player.r, Math.min(world.width - player.r, newX));
  player.y = Math.max(player.r, Math.min(world.height - player.r, newY));

  // Storm Logikk (Inkludert Bots Damage)
  if (stormActive) {
    stormElapsed += dt;
    const t = Math.min(1, stormElapsed / stormShrinkTime);
    stormRadius = Math.max(300, (world.width * 0.45) * (1 - t) + 300 * t);
    stormBarFill.style.width = (100 - t * 100) + "%";
    stormText.textContent = t < 1 ? "Krymper" : "Full storm";

    if (Math.hypot(player.x - stormCenter.x, player.y - stormCenter.y) > stormRadius) player.hp -= 8 * (dt / 1000);
  }

  // Bot-løkke med Storm Damage (2 damage/sek)
  for (const bot of bots) {
    const distToStorm = Math.hypot(bot.x - stormCenter.x, bot.y - stormCenter.y);
    if (stormActive && distToStorm > stormRadius) {
      bot.hp -= 2 * (dt / 1000); // HER skjer bot damage i stormen
    }

    const dx = player.x - bot.x, dy = player.y - bot.y, dist = Math.hypot(dx, dy) || 1;
    bot.wanderTimer -= dt;
    if (bot.wanderTimer <= 0) {
      bot.wanderTimer = 1000 + Math.random() * 1500;
      bot.vx = (dx / dist) * bot.speed; bot.vy = (dy / dist) * bot.speed;
    }
    bot.x += bot.vx * (dt / 16.67); bot.y += bot.vy * (dt / 16.67);
    if (dist < bot.r + player.r + 4 && player.z < 10) player.hp -= 15 * (dt / 1000);
  }

  // Bullets & Kills
  bullets.forEach(b => { b.x += b.vx; b.y += b.vy; b.life -= dt; });
  bullets = bullets.filter(b => b.life > 0);
  bullets.forEach(b => bots.forEach(bot => {
    if (Math.hypot(b.x - bot.x, b.y - bot.y) < bot.r) { bot.hp -= b.dmg; b.life = 0; }
  }));

  bots.forEach(bot => { if (bot.hp <= 0) { kills++; killText.textContent = kills; } });
  bots = bots.filter(bot => bot.hp > 0);

  // Våpen pick-up
  weapons = weapons.filter(w => {
    if (Math.hypot(player.x - w.x, player.y - w.y) < player.r + w.r + 5) {
      for (let i = 0; i < 5; i++) if (!player.weaponSlots[i]) { player.weaponSlots[i] = w.type; break; }
      updateToolbar(); updateWeaponText(); return false;
    }
    return true;
  });

  if (shootPressed && shootCooldown <= 0) {
    const w = player.weaponSlots[player.activeSlot];
    if (w) {
      bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.aimAngle)*w.bulletSpeed, vy: Math.sin(player.aimAngle)*w.bulletSpeed, dmg: w.dmg, life: 1000, color: w.color, r: 4 });
      shootCooldown = w.fireRate;
    }
  }
  shootCooldown -= dt;

  if (player.hp <= 0) { gameRunning = false; gameOverEl.style.display = 'flex'; gameOverText.textContent = "Du døde!"; }
  if (bots.length === 0 && totalBotsSpawned >= MAX_BOTS_TOTAL) { gameRunning = false; gameOverEl.style.display = 'flex'; gameOverText.textContent = "Victory Royale!"; }
  
  hpText.textContent = Math.ceil(player.hp);
  botsText.textContent = bots.length;
}

function draw() {
  ctx.clearRect(0, 0, W(), H());
  ctx.save();
  ctx.translate(-player.x + W()/2, -player.y + H()/2);
  
  ctx.fillStyle = "#10151c"; ctx.fillRect(0, 0, world.width, world.height);
  ctx.strokeStyle = "rgba(120, 180, 255, 0.3)"; ctx.lineWidth = 5;
  ctx.beginPath(); ctx.arc(stormCenter.x, stormCenter.y, stormRadius, 0, Math.PI*2); ctx.stroke();

  blocks.forEach(b => { ctx.fillStyle = "#1f2933"; ctx.fillRect(b.x, b.y, b.w, b.h); });
  weapons.forEach(w => { ctx.fillStyle = w.type.color; ctx.beginPath(); ctx.arc(w.x, w.y, w.r, 0, Math.PI*2); ctx.fill(); });
  bots.forEach(bot => { ctx.fillStyle = "#f55"; ctx.beginPath(); ctx.arc(bot.x, bot.y, bot.r, 0, Math.PI*2); ctx.fill(); });
  bullets.forEach(b => { ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); });

  ctx.save(); ctx.translate(player.x, player.y - player.z); ctx.rotate(player.aimAngle);
  ctx.fillStyle = "#4cf"; ctx.beginPath(); ctx.arc(0, 0, player.r, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = "#fff"; ctx.fillRect(10, -2, 10, 4); ctx.restore();

  ctx.restore();
}

// Enkel Joystick Logikk
joystickArea.addEventListener('touchstart', e => {
  joystickActive = true;
  joystickCenter = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  joystickBase.style.display = joystickStick.style.display = 'block';
  joystickBase.style.left = joystickCenter.x + 'px'; joystickBase.style.top = joystickCenter.y + 'px';
});
window.addEventListener('touchmove', e => {
  if (!joystickActive) return;
  const dx = e.touches[0].clientX - joystickCenter.x, dy = e.touches[0].clientY - joystickCenter.y;
  const dist = Math.min(60, Math.hypot(dx, dy));
  const angle = Math.atan2(dy, dx);
  joystickVector = { x: Math.cos(angle) * (dist/60), y: Math.sin(angle) * (dist/60) };
  player.aimAngle = angle;
  joystickStick.style.left = (joystickCenter.x + Math.cos(angle)*dist) + 'px';
  joystickStick.style.top = (joystickCenter.y + Math.sin(angle)*dist) + 'px';
});
window.addEventListener('touchend', () => { joystickActive = false; joystickVector = {x:0, y:0}; joystickBase.style.display = joystickStick.style.display = 'none'; });

function loop(t) { update(t - lastTime); draw(); lastTime = t; requestAnimationFrame(loop); }
function initBots() { for(let i=0; i<15; i++) spawnBot(); }
restartBtn.onclick = resetGame;
resetGame();
requestAnimationFrame(loop);
setInterval(() => { if(gameRunning && bots.length < 10) spawnBot(); }, 3000);
</script>
</body>
</html>
